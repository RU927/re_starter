#!/bin/bash


# Проверяем, был ли предоставлен входной аргумент
if [ "$#" -lt 1 ]; then
    echo "Использование: $0 [-a] [-s] [--fzf] [--rofi] [--dmenu] имя_файла"
    exit 1
fi

# Обрабатываем опции командной строки
all=false
silent=false
menu=""
menu_command=""
while getopts ":asf:r:d:" opt; do
  case ${opt} in
    a )
      all=true
      ;;
    s )
      silent=true
      ;;
    f )
      menu="fzf"
      menu_command="fzf"
      ;;
    r )
      menu="rofi"
      menu_command="rofi -dmenu -i -p 'Выберите приложение:'"
      ;;
    d )
      menu="dmenu"
      menu_command="dmenu"
      ;;
    \? )
      echo "Неверная опция: -$OPTARG" 1>&2
      exit 1
      ;;
  esac
done
shift $((OPTIND -1))

# Получаем тип файла
file_type=$(mimetype -b "$1")

# Ищем соответствующие приложения в ~/.config/mimeapps.list
apps=$(grep "$file_type" ~/.config/mimeapps.list | cut -d '=' -f 2 | tr ';' '\n' | sed '/^$/d' | xargs -n 1 basename)

# Если список приложений пуст, ищем в ~/.local/share/applications/
if [ -z "$apps" ]; then
    new_apps=$(grep "$file_type" ~/.local/share/applications/*.desktop | cut -d ':' -f 1 | xargs -n 1 basename)
    if [ -n "$new_apps" ]; then
        apps=$new_apps
    fi
fi

# Если список приложений все еще пуст или задана опция -a, ищем в /usr/share/applications/ и пополняем список поддерживаемых приложений системным путём
if [ -z "$apps" ] || [ "$all" = true ]; then
    new_apps=$(grep "$file_type" /usr/share/applications/*.desktop | cut -d ':' -f 1 | xargs -n 1 basename)
    if [ -n "$new_apps" ]; then
        apps+=$new_apps
    fi
fi

# Если список приложений все еще пуст, выводим сообщение об ошибке и выходим
if [ -z "$apps" ]; then
    echo "Не найдено приложений, способных обработать файл $1" 1>&2
    exit 1
fi

# Если задана опция -a или есть более одного приложения, передаем список приложений в dmenu
if [ "$all" = true ] || [ "$(echo "$apps" | wc -l)" -gt 1 ]; then
    if [ "$silent" = true ]; then
        app=$(echo "$apps" | head -n 1)
    else
        if [ -n "$menu" ] && command -v $menu >/dev/null; then
            app=$(echo "$apps" | eval $menu_command)
        else
            echo "Выберите приложение из списка:"
            select app in $apps; do
                break
            done
        fi
    fi
else
    app=$(echo "$apps" | head -n 1)
fi

# Открываем файл с выбранным приложением
run-desktop "$app" "$@" >/dev/null 2>&1 &

# Если задана опция -s, пропускаем диалог о добавлении или изменении приложения
if [ "$silent" = false ]; then
    # Проверяем, установлен ли handlr или xdg-utils
    if command -v handlr >/dev/null; then
        handler="handlr"
        handler_command="set $file_type $app"
    elif command -v xdg-mime >/dev/null; then
        handler="xdg-mime"
        handler_command="default $app $file_type"
    else
        echo "Не установлены handlr или xdg-utils" 1>&2
        exit 1
    fi

    # Если приложение не найдено в ~/.config/mimeapps.list или было выбрано другое приложение, начинаем диалог о добавлении или изменении приложения
    if [ -z "$(grep "$file_type=$app" ~/.config/mimeapps.list)" ] || [ "$app" != "$(echo "$apps" | head -n 1)" ]; then
        if [ -n "$menu" ] && command -v $menu >/dev/null; then
            yn=$(echo -e "y\nn" | eval $menu_command)
        else
            read -p "Хотите добавить или изменить $app в ~/.config/mimeapps.list для $file_type? (y/n) " yn
        fi
        case $yn in
            [Yy]* ) $handler $handler_command;;
            * ) echo "Пропускаем добавление или изменение приложения";;
        esac
    fi
fi
